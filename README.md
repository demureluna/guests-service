# Guests Service
Проект GuestsService - это микросервис, реализующий через Middleware API для CRUD-операций над гостями.

## API Reference

### **AddGuest**

```http
POST /api/guests/add/
```

Метод, позволяющий добавить гостя в базу

| Параметр  | Тип      | Описание                  |
| --------- | -------- | ------------------------- |
| `name`    | `string` | **Обязательный** Имя гостя |
| `surname` | `string` | **Обязательный** Фамилия гостя |
| `phone` | `string` | **Обязательный** Номер телефона гостя. Должен быть в **международном** формате |
| `email` | `string` | *Необязательный* Адрес электропочты гостя |
| `country` | `string` | *Необязательный* Страна происхождения гостя |

- Ответ:

```json
{
    "api_version": "1.0",
    "data": {
        "id": null,
        "kind": "guest",
        "fields": [
            "name",
            "surname",
            "phone",
            "email",
            "country"
        ],
        "items": {
            "name": "Ivan",
            "surname": "Ivanov",
            "phone": "+79531290006",
            "email": "ivanov.i@ya.ru",
            "country": "RU"
        }
    }
}
```

### **GetGuest**

```http
GET /api/guests/get/
```

Метод, позволяющий получить информацию о госте из базы.  
**Обязательно** передать один из трех обязательных параметров

| Параметр  | Тип      | Описание                  |
| --------- | -------- | ------------------------- |
| `id` | `string` | **Обязательный** id гостя в базе данных |
| `phone` | `string` | **Обязательный** Номер телефона гостя. Должен быть в **международном** формате |
| `email` | `string` | **Обязательный** Адрес электропочты гостя |

- Ответ

```json
{
    "api_version": "1.0",
    "data": {
        "id": 4,
        "kind": "guest",
        "fields": [
            "id",
            "name",
            "surname",
            "email",
            "phone",
            "country",
            "created_at",
            "updated_at"
        ],
        "items": {
            "id": 4,
            "name": "Ivan",
            "surname": "Ivanov",
            "email": "ivanov.i@ya.ru",
            "phone": "+79531290006",
            "country": "RU",
            "created_at": "2024-08-15T00:13:05.000000Z",
            "updated_at": "2024-08-15T00:13:05.000000Z"
        }
    }
}
```

### **UpdateGuest**

```http
PATCH /api/guests/update/
```

Метод, обновляющий информацию о пользователе в базе данных

| Параметр  | Тип      | Описание                  |
| --------- | -------- | ------------------------- |
| `id` | `string` | **Обязательный** id гостя в базе данных |
| `name`    | `string` | *Необязательный* Имя гостя |
| `surname` | `string` | *Необязательный* Фамилия гостя |
| `phone` | `string` | *Необязательный* Номер телефона гостя. Должен быть в **международном** формате |
| `email` | `string` | *Необязательный* Адрес электропочты гостя |
| `country` | `string` | *Необязательный* Страна происхождения гостя |

- Ответ

```json
{
    "api_version": "1.0",
    "data": {
        "id": "4",
        "kind": "guest",
        "fields": [
            "name",
            "email"
        ],
        "items": {
            "name": "Alexey",
            "email": "ivanov.a@ya.ru"
        }
    }
}
```

### **DeleteGuest**

```http
DELETE /api/guests/delete/
```

Метод, удаляющий пользователя из базы данных

| Параметр  | Тип      | Описание                  |
| --------- | -------- | ------------------------- |
| `id` | `string` | **Обязательный** id гостя в базе данных |

- Ответ

```json
{
    "api_version": "1.0",
    "data": {
        "id": "4",
        "kind": "guest",
        "items": {
            "deleted": true
        }
    }
}
```

## Развертка локального окружения и запуск проекта
Запускается проект с локальным окружением через Docker. 
Для начала, скачайте сам репозиторий:
```
git clone https://github.com/demureluna/guests-service.git
```

После скачивания, необходимо переименовать файл ```.env.dist``` в ```.env```, и заполнить его актуальными данными для подключения.

Затем, для развертки можно запустить скрипт:
```
bash ./startup.sh
```

Или выполнить последовательность команд:
```
docker build -it guestsservice .
docker compose up -d
docker exec -it guestsservice vendor/bin/phpmig migrate
```

## Структура проекта
Проект написан с использованием Middleware-фреймворка *Mezzio*, так что основной код лежит в папке **src**.
Ниже описаны основные папки и файлы, и за что они отвечают:
- config - папка с основными конфигурационными файлами проекта;
    - config.php - основной файл конфигурации Mezzio, в нем описаны все подключенные модули, а также autoload-механизм;
    - routes.php - файл роутинга, в котором хранятся все эндпоинты, их HTTP-методы, а также обработчики, закрепленные за ними;

- docker - папка с конфигурационными файлами для развертки локального окружения, в частности - nginx-конфиги;

- migrations - папка с миграциями в базу данных проекта. Для миграций используется библиотека **phpmig**;

- public
    - index.php - точка запуска проекта. В этом файле подключаются все конфигурационные файлы, загружается локальный .env файл и запускается Mezzio-приложение; 

- src - папка, содержащая основной код проекта;
    - App - папка системного модуля, хранит в себе общие файлы хелперов/моделей/etc., доступ к которым можно получить из любого другого модуля;
        - src
            - Constant - папка, содержащая классы с **константами**;
            - Database - папка моделей базы данных;
                - Entities - файлы, в которые вынесена бизнес-логика из моделей;
                - Interfaces - интерфейсы сущностей, определяющие их набор методов;
                - Models - модели базы данных;
            - Exception - папка, содержащая кастомные обработчики ошибок;
            - Helper - папка, хранящая общие хелперы для работы с данными;
                - PhoneHelper.php - хелпер, валидирующий номера телефонов. Для парсинга номера и валидации используется библиотека **libphonenumber**;
                - JsonHelper.php - хелпер, форматирующий JSON-ответы. В качестве рефернса для формата использовался **Google JSON Style Gude**;
    - GuestsService - папка модуля GuestsService, реализующего API для CRUD-операций над гостями;
        - src
            - Factory - папка, хранящая фабрики обработчиков, собирающие для них объекты, и вызывающие их;
            - Handler - папка, хранящая сами обработчики эндпоинтов API;
            - Service - папка, хранящая сервисы, в которые вынесена все бизнес-логика обработчиков;
            - ConfigProvider.php - файл, связывающий обработчики с их фабриками, и подключаемый в файл config/config.php;

- .env.dist - образец .env-файла проекта;
- composer.json - файл, содержащий все сторонние библиотеки и их зависимости.